<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manga List Terbaru</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset dan Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            line-height: 1.5;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Container */
        .container {
            max-width: 100%;
            padding: 10px;
            margin: 0 auto;
        }
        
        /* Header - DIPERKECIL */
        header {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 40px;
        }
        
        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .logo i {
            color: #ff6b6b;
            font-size: 1.1rem;
        }
        
        .nav-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            transition: background 0.2s;
            white-space: nowrap;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .subtitle {
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 2px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Loading dan Error */
        .loading, .error, .empty {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }
        
        .loading i {
            font-size: 2rem;
            color: #ff6b6b;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            color: #ff6b6b;
        }
        
        .empty i {
            font-size: 2.5rem;
            color: #666;
            margin-bottom: 15px;
        }
        
        /* Manga Grid - Halaman Utama */
        .manga-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        /* Manga Card */
        .manga-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }
        
        .manga-card:hover, .manga-card:focus {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .manga-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
            background-color: #2d3748;
        }
        
        .manga-info {
            padding: 10px;
        }
        
        .manga-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 6px;
            color: #fff;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 2.6em;
        }
        
        .manga-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .manga-rating {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .manga-type {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 8px;
        }
        
        .latest-chapter {
            font-size: 0.8rem;
            color: #aaa;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Halaman Detail Manga */
        #detail-page {
            display: none;
        }
        
        .manga-detail {
            margin-top: 15px;
        }
        
        .detail-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .detail-header {
                flex-direction: row;
            }
        }
        
        .detail-thumbnail {
            width: 100%;
            max-width: 200px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .detail-thumbnail img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .detail-info {
            flex: 1;
        }
        
        .detail-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
        }
        
        .detail-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .meta-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 6px;
        }
        
        .meta-label {
            font-size: 0.75rem;
            color: #aaa;
            margin-bottom: 3px;
        }
        
        .meta-value {
            font-weight: 600;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .genres {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }
        
        .genre-tag {
            background: rgba(156, 39, 176, 0.2);
            color: #ce93d8;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 16px;
        }
        
        .synopsis {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .synopsis h3 {
            color: #fff;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        /* Chapters List */
        .chapters-section {
            margin-top: 20px;
        }
        
        .chapters-section h3 {
            color: #fff;
            margin-bottom: 12px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chapters-list {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            overflow: hidden;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .chapter-item:last-child {
            border-bottom: none;
        }
        
        .chapter-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .chapter-title {
            font-weight: 500;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .chapter-date {
            font-size: 0.8rem;
            color: #aaa;
            flex-shrink: 0;
            margin-left: 10px;
        }
        
        /* Halaman Reader Chapter */
        #reader-page {
            display: none;
        }
        
        .reader-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 5px;
        }
        
        .reader-header {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            top: 55px;
            z-index: 90;
        }
        
        .reader-title {
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Reader Controls - SATU BARIS */
        .reader-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .reader-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.85rem;
            flex: 1;
            justify-content: center;
            min-width: 0;
            max-width: 48%;
        }
        
        .reader-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .reader-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .reader-btn.primary {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .reader-btn.primary:hover:not(:disabled) {
            background: rgba(255, 107, 107, 0.3);
        }
        
        /* Chapter Images */
        .chapter-images {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        
        .chapter-image-container {
            position: relative;
            width: 100%;
            min-height: 80px;
            background: linear-gradient(45deg, #2d3748, #4a5568);
            overflow: hidden;
        }
        
        .chapter-image {
            width: 100%;
            height: auto;
            display: block;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .chapter-image.loaded {
            opacity: 1;
        }
        
        .image-number {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            z-index: 2;
        }
        
        .reader-progress {
            margin-top: 15px;
            text-align: center;
            color: #aaa;
            font-size: 0.8rem;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ff8e53);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Pagination - SATU BARIS */
        .pagination {
            display: flex !important;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            gap: 8px;
        }
        
        .pagination button {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.85rem;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-width: 0;
            max-width: 48%;
        }
        
        .pagination button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 0.8rem;
            color: #aaa;
            flex-shrink: 0;
            padding: 0 10px;
            min-width: 80px;
            text-align: center;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 15px;
        }
        
        /* Optimasi untuk HP Kentang */
        @media (max-width: 480px) {
            .manga-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
            
            .manga-thumbnail {
                height: 160px;
            }
            
            .container {
                padding: 8px;
            }
            
            header {
                padding: 6px 8px;
            }
            
            .logo {
                font-size: 1.1rem;
            }
            
            .logo i {
                font-size: 1rem;
            }
            
            .detail-title {
                font-size: 1.3rem;
            }
            
            .detail-meta-grid {
                grid-template-columns: 1fr;
            }
            
            .reader-controls {
                gap: 4px;
            }
            
            .reader-btn {
                padding: 7px 10px;
                font-size: 0.8rem;
            }
            
            .nav-buttons {
                gap: 4px;
            }
            
            .nav-btn {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            .nav-btn .btn-text {
                display: none;
            }
            
            .nav-btn i {
                margin: 0;
            }
        }
        
        @media (max-width: 360px) {
            .manga-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }
            
            .manga-thumbnail {
                height: 140px;
            }
            
            .manga-title {
                font-size: 0.85rem;
            }
            
            .detail-title {
                font-size: 1.1rem;
            }
            
            .reader-title {
                font-size: 0.9rem;
            }
            
            .pagination button {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .page-info {
                font-size: 0.75rem;
                min-width: 60px;
            }
        }
        
        /* Animasi sederhana */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* Utilitas */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-15 {
            margin-top: 15px;
        }
        
        /* Scrollbar styling */
        .chapters-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .chapters-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .chapters-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .chapters-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div>
                <div class="logo" id="logo-btn">
                    <i class="fas fa-book-open"></i>
                    <span id="logo-text">Manga List</span>
                </div>
                <div class="subtitle" id="subtitle">Daftar manga terbaru dari Komikcast</div>
            </div>
            <div class="nav-buttons">
                <button id="back-btn" class="nav-btn hidden">
                    <i class="fas fa-arrow-left"></i> <span class="btn-text">Kembali</span>
                </button>
                <button id="reader-back-btn" class="nav-btn hidden">
                    <i class="fas fa-book"></i> <span class="btn-text">Detail</span>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Halaman Utama (Daftar Manga) -->
    <main class="container" id="main-page">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Memuat manga terbaru...</p>
        </div>
        
        <!-- Error State -->
        <div id="error" class="error">
            <i class="fas fa-exclamation-triangle"></i>
            <p id="error-message">Gagal memuat data manga.</p>
            <button id="retry-btn" class="retry-btn">
                Coba Lagi
            </button>
        </div>
        
        <!-- Empty State -->
        <div id="empty" class="empty">
            <i class="fas fa-book"></i>
            <p>Tidak ada manga yang ditemukan.</p>
        </div>
        
        <!-- Manga Grid -->
        <div id="manga-grid" class="manga-grid"></div>
        
        <!-- Pagination - SATU BARIS -->
        <div id="pagination" class="pagination" style="display: none;">
            <button id="prev-btn" disabled>
                <i class="fas fa-chevron-left"></i> Sebelumnya
            </button>
            <div class="page-info">Halaman <span id="current-page">1</span></div>
            <button id="next-btn">
                Selanjutnya <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </main>
    
    <!-- Halaman Detail Manga -->
    <div class="container" id="detail-page">
        <!-- Loading State Detail -->
        <div id="detail-loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Memuat detail manga...</p>
        </div>
        
        <!-- Error State Detail -->
        <div id="detail-error" class="error">
            <i class="fas fa-exclamation-triangle"></i>
            <p id="detail-error-message">Gagal memuat detail manga.</p>
            <button id="detail-retry-btn" class="retry-btn">
                Coba Lagi
            </button>
        </div>
        
        <!-- Detail Manga Content -->
        <div id="detail-content" class="manga-detail"></div>
    </div>
    
    <!-- Halaman Reader Chapter -->
    <div class="container" id="reader-page">
        <!-- Loading State Reader -->
        <div id="reader-loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Memuat chapter...</p>
        </div>
        
        <!-- Error State Reader -->
        <div id="reader-error" class="error">
            <i class="fas fa-exclamation-triangle"></i>
            <p id="reader-error-message">Gagal memuat chapter.</p>
            <button id="reader-retry-btn" class="retry-btn">
                Coba Lagi
            </button>
        </div>
        
        <!-- Reader Content -->
        <div id="reader-content" class="reader-container" style="display: none;">
            <div class="reader-controls" style="margin-bottom: 15px;">
                <button id="prev-chapter-btn" class="reader-btn" disabled>
                    <i class="fas fa-chevron-left"></i> <span class="btn-text">Prev</span>
                </button>
                <button id="next-chapter-btn" class="reader-btn primary">
                    <span class="btn-text">Next</span> <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div id="chapter-images" class="chapter-images"></div>
            
            <!-- Bottom Controls juga SATU BARIS -->
            <div class="reader-controls mt-15">
                <button id="prev-chapter-btn-bottom" class="reader-btn" disabled>
                    <i class="fas fa-chevron-left"></i> <span class="btn-text">Prev</span>
                </button>
                <button id="next-chapter-btn-bottom" class="reader-btn primary">
                    <span class="btn-text">Next</span> <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="reader-progress" id="reader-progress-text">
                Memuat gambar...
            </div>
        </div>
    </div>
    
    <footer>
        <p>Data diambil dari Komikcast API • Dibuat untuk HP Kentang</p>
        <p style="margin-top: 5px; font-size: 0.7rem;">© 2023 Manga List Viewer</p>
    </footer>

    <script>
        // Konfigurasi API
        const API_BASE = 'https://unofficial-komikcast-api.vercel.app';
        const LATEST_API = `${API_BASE}/komikcast/latest`;
        
        // State aplikasi
        let currentView = 'list'; // 'list', 'detail', atau 'reader'
        let currentPage = 1;
        let currentMangaSlug = '';
        let currentChapterSlug = '';
        let currentMangaTitle = '';
        let currentChapterData = null;
        
        // State untuk lazy loading
        let imageObserver = null;
        let loadedImagesCount = 0;
        let totalImagesCount = 0;
        
        // Elemen DOM
        const mainPageEl = document.getElementById('main-page');
        const detailPageEl = document.getElementById('detail-page');
        const readerPageEl = document.getElementById('reader-page');
        
        // Loading dan Error elements
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const emptyEl = document.getElementById('empty');
        const detailLoadingEl = document.getElementById('detail-loading');
        const detailErrorEl = document.getElementById('detail-error');
        const readerLoadingEl = document.getElementById('reader-loading');
        const readerErrorEl = document.getElementById('reader-error');
        const readerContentEl = document.getElementById('reader-content');
        
        // Content elements
        const mangaGridEl = document.getElementById('manga-grid');
        const detailContentEl = document.getElementById('detail-content');
        const chapterImagesEl = document.getElementById('chapter-images');
        
        // Navigation elements
        const backBtn = document.getElementById('back-btn');
        const readerBackBtn = document.getElementById('reader-back-btn');
        const logoBtn = document.getElementById('logo-btn');
        const logoTextEl = document.getElementById('logo-text');
        const subtitleEl = document.getElementById('subtitle');
        
        // Pagination elements
        const paginationEl = document.getElementById('pagination');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const currentPageEl = document.getElementById('current-page');
        
        // Reader control elements
        const chapterTitleEl = document.getElementById('chapter-title');
        const prevChapterBtn = document.getElementById('prev-chapter-btn');
        const nextChapterBtn = document.getElementById('next-chapter-btn');
        const prevChapterBtnBottom = document.getElementById('prev-chapter-btn-bottom');
        const nextChapterBtnBottom = document.getElementById('next-chapter-btn-bottom');
        const readingProgressEl = document.getElementById('reading-progress');
        const readerProgressText = document.getElementById('reader-progress-text');
        
        // Retry buttons
        const retryBtn = document.getElementById('retry-btn');
        const detailRetryBtn = document.getElementById('detail-retry-btn');
        const readerRetryBtn = document.getElementById('reader-retry-btn');
        
        // Tambahkan style untuk tombol retry
        const style = document.createElement('style');
        style.textContent = `
            .retry-btn {
                margin-top: 15px;
                padding: 8px 20px;
                background: #ff6b6b;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            
            .retry-btn:hover {
                background: #ff5252;
            }
        `;
        document.head.appendChild(style);
        
        // ========== FUNGSI UTILITAS ==========
        
        function showElement(element) {
            element.style.display = 'block';
        }
        
        function hideElement(element) {
            element.style.display = 'none';
        }
        
        function showListView() {
            currentView = 'list';
            mainPageEl.style.display = 'block';
            detailPageEl.style.display = 'none';
            readerPageEl.style.display = 'none';
            
            backBtn.classList.add('hidden');
            readerBackBtn.classList.add('hidden');
            
            logoTextEl.textContent = 'Manga List';
            subtitleEl.textContent = 'Daftar manga terbaru dari Komikcast';
            
            updateUrlHash('');
        }
        
        function showDetailView() {
            currentView = 'detail';
            mainPageEl.style.display = 'none';
            detailPageEl.style.display = 'block';
            readerPageEl.style.display = 'none';
            
            backBtn.classList.remove('hidden');
            readerBackBtn.classList.add('hidden');
            
            updateUrlHash(`manga-${currentMangaSlug}`);
        }
        
        function showReaderView() {
            currentView = 'reader';
            mainPageEl.style.display = 'none';
            detailPageEl.style.display = 'none';
            readerPageEl.style.display = 'block';
            
            backBtn.classList.add('hidden');
            readerBackBtn.classList.remove('hidden');
            
            updateUrlHash(`chapter-${currentChapterSlug}`);
        }
        
        function updateUrlHash(hash) {
            if (history.pushState) {
                const newUrl = hash ? `#${hash}` : window.location.pathname;
                history.pushState(null, '', newUrl);
            }
        }
        
        // ========== FUNGSI LAZY LOADING ==========
        
        function initLazyLoading() {
            // Hapus observer lama jika ada
            if (imageObserver) {
                imageObserver.disconnect();
            }
            
            // Reset counters
            loadedImagesCount = 0;
            
            // Buat Intersection Observer baru
            imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadImage(img);
                        imageObserver.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px', // Load gambar 50px sebelum masuk viewport
                threshold: 0.1
            });
        }
        
        function loadImage(img) {
            // Jika gambar sudah memiliki src (sudah diload), skip
            if (img.dataset.src) {
                const src = img.dataset.src;
                img.src = src;
                delete img.dataset.src;
                
                // Tambahkan event listener untuk tracking load
                img.onload = () => handleImageLoad(img);
                img.onerror = () => handleImageError(img);
            }
        }
        
        function handleImageLoad(img) {
            loadedImagesCount++;
            updateProgress();
            
            // Tambahkan class loaded untuk fade in effect
            img.classList.add('loaded');
        }
        
        function handleImageError(img) {
            loadedImagesCount++;
            updateProgress();
            
            // Tampilkan placeholder untuk gambar error
            img.style.filter = 'grayscale(100%)';
            img.style.opacity = '0.5';
            img.classList.add('loaded');
        }
        
        function updateProgress() {
            const progress = Math.round((loadedImagesCount / totalImagesCount) * 100);
            readingProgressEl.style.width = `${progress}%`;
            readerProgressText.textContent = `Memuat gambar (${loadedImagesCount}/${totalImagesCount})`;
            
            if (loadedImagesCount === totalImagesCount) {
                readerProgressText.textContent = `Selesai memuat ${totalImagesCount} gambar`;
            }
        }
        
        // ========== FUNGSI API ==========
        
        async function fetchWithTimeout(url, timeout = 15000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }
        
        async function fetchManga(page = 1) {
            showElement(loadingEl);
            hideElement(errorEl);
            hideElement(emptyEl);
            hideElement(paginationEl);
            mangaGridEl.innerHTML = '';
            
            try {
                const url = page > 1 ? `${LATEST_API}?page=${page}` : LATEST_API;
                const response = await fetchWithTimeout(url);
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                hideElement(loadingEl);
                
                if (!data.data || data.data.length === 0) {
                    showElement(emptyEl);
                    return;
                }
                
                renderMangaList(data.data);
                updatePagination(data.meta);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error fetching manga:', error);
                hideElement(loadingEl);
                
                document.getElementById('error-message').textContent = 
                    error.name === 'AbortError' 
                    ? 'Waktu permintaan habis. Periksa koneksi internet Anda.'
                    : `Gagal memuat data: ${error.message}`;
                
                showElement(errorEl);
            }
        }
        
        async function fetchMangaDetail(slug) {
            showElement(detailLoadingEl);
            hideElement(detailErrorEl);
            detailContentEl.innerHTML = '';
            
            currentMangaSlug = slug;
            logoTextEl.textContent = 'Loading...';
            subtitleEl.textContent = 'Mengambil detail manga';
            
            try {
                const url = `${API_BASE}/komikcast/detail/${slug}`;
                const response = await fetchWithTimeout(url);
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                hideElement(detailLoadingEl);
                
                renderMangaDetail(data.data);
                currentMangaTitle = data.data.title || 'Unknown Manga';
                
                logoTextEl.textContent = data.data.title || 'Detail Manga';
                subtitleEl.textContent = 'Detail manga dari Komikcast';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error fetching manga detail:', error);
                hideElement(detailLoadingEl);
                
                document.getElementById('detail-error-message').textContent = 
                    error.name === 'AbortError' 
                    ? 'Waktu permintaan habis. Periksa koneksi internet Anda.'
                    : `Gagal memuat detail manga: ${error.message}`;
                
                showElement(detailErrorEl);
                logoTextEl.textContent = 'Error';
                subtitleEl.textContent = 'Gagal memuat detail manga';
            }
        }
        
        async function fetchChapterImages(slug) {
            showElement(readerLoadingEl);
            hideElement(readerErrorEl);
            hideElement(readerContentEl);
            chapterImagesEl.innerHTML = '';
            
            currentChapterSlug = slug;
            chapterTitleEl.textContent = 'Memuat...';
            readerProgressText.textContent = 'Memuat gambar...';
            readingProgressEl.style.width = '0%';
            
            try {
                const url = `${API_BASE}/komikcast/chapter/${slug}`;
                const response = await fetchWithTimeout(url);
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                currentChapterData = data.data;
                
                hideElement(readerLoadingEl);
                showElement(readerContentEl);
                
                renderChapterImages(data.data);
                updateChapterNavigation(data.data);
                
                chapterTitleEl.textContent = data.data.title || 'Chapter';
                logoTextEl.textContent = currentMangaTitle || 'Manga Reader';
                subtitleEl.textContent = data.data.title || 'Membaca chapter';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error fetching chapter:', error);
                hideElement(readerLoadingEl);
                
                document.getElementById('reader-error-message').textContent = 
                    error.name === 'AbortError' 
                    ? 'Waktu permintaan habis. Periksa koneksi internet Anda.'
                    : `Gagal memuat chapter: ${error.message}`;
                
                showElement(readerErrorEl);
                chapterTitleEl.textContent = 'Error';
                logoTextEl.textContent = 'Error';
                subtitleEl.textContent = 'Gagal memuat chapter';
            }
        }
        
        // ========== RENDER FUNCTIONS ==========
        
        function renderMangaList(mangaList) {
            mangaGridEl.innerHTML = '';
            
            mangaList.forEach((manga, index) => {
                const card = document.createElement('div');
                card.className = 'manga-card fade-in';
                card.style.animationDelay = `${index * 0.05}s`;
                card.dataset.slug = manga.slug;
                
                const thumbnail = manga.thumbnail || 'https://via.placeholder.com/150x200/2d3748/4a5568?text=No+Image';
                
                card.innerHTML = `
                    <img src="${thumbnail}" alt="${manga.title}" class="manga-thumbnail" loading="lazy">
                    <div class="manga-info">
                        <h3 class="manga-title" title="${manga.title}">${manga.title}</h3>
                        <div class="manga-meta">
                            <div class="manga-rating">
                                <i class="fas fa-star"></i> ${manga.rating || 'N/A'}
                            </div>
                            <div class="manga-type">${manga.type || 'Manga'}</div>
                        </div>
                        <div class="latest-chapter" title="${manga.latest_chapter?.title || 'Tidak diketahui'}">
                            ${manga.latest_chapter?.title || 'Tidak diketahui'}
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    showMangaDetail(manga.slug);
                });
                
                mangaGridEl.appendChild(card);
            });
        }
        
        function renderMangaDetail(manga) {
            const thumbnail = manga.thumbnail || 'https://via.placeholder.com/250x350/2d3748/4a5568?text=No+Image';
            const rating = manga.rating || 'N/A';
            
            let genresHtml = '';
            if (manga.genres && manga.genres.length > 0) {
                genresHtml = manga.genres.map(genre => 
                    `<span class="genre-tag">${genre}</span>`
                ).join('');
            } else {
                genresHtml = '<span class="genre-tag">Tidak ada genre</span>';
            }
            
            let chaptersHtml = '';
            if (manga.chapters && manga.chapters.length > 0) {
                // URUTKAN DESCENDING berdasarkan nomor chapter
                const sortedChapters = [...manga.chapters].sort((a, b) => {
                    // Ekstrak angka dari judul chapter
                    const getChapterNumber = (title) => {
                        if (!title) return 0;
                        // Cari angka dalam judul chapter
                        const match = title.match(/(\d+(\.\d+)?)/);
                        return match ? parseFloat(match[1]) : 0;
                    };
                    
                    const numA = getChapterNumber(a.title);
                    const numB = getChapterNumber(b.title);
                    
                    // Urutkan descending (terbaru/tertinggi di atas)
                    return numB - numA;
                });
                
                chaptersHtml = sortedChapters.map(chapter => {
                    const date = chapter.released_at ? 
                        new Date(chapter.released_at).toLocaleDateString('id-ID', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric'
                        }) : 'Tanggal tidak diketahui';
                    
                    return `
                        <div class="chapter-item" data-slug="${chapter.slug}">
                            <div class="chapter-title">${chapter.title || 'Chapter tanpa judul'}</div>
                            <div class="chapter-date">${date}</div>
                        </div>
                    `;
                }).join('');
            } else {
                chaptersHtml = `
                    <div class="chapter-item">
                        <div class="chapter-title">Tidak ada chapter tersedia</div>
                    </div>
                `;
            }
            
            detailContentEl.innerHTML = `
                <div class="manga-detail">
                    <div class="detail-header fade-in">
                        <div class="detail-thumbnail">
                            <img src="${thumbnail}" alt="${manga.title}" loading="lazy">
                        </div>
                        <div class="detail-info">
                            <h1 class="detail-title">${manga.title}</h1>
                            <div class="detail-meta-grid">
                                <div class="meta-item">
                                    <div class="meta-label">Rating</div>
                                    <div class="meta-value">
                                        <i class="fas fa-star" style="color: #ffc107;"></i> ${rating}
                                    </div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">Tipe</div>
                                    <div class="meta-value">${manga.type || 'Tidak diketahui'}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">Status</div>
                                    <div class="meta-value">${manga.status || 'Tidak diketahui'}</div>
                                </div>
                            </div>
                            <div class="genres">
                                ${genresHtml}
                            </div>
                        </div>
                    </div>
                    
                    <div class="synopsis fade-in" style="animation-delay: 0.1s">
                        <h3><i class="fas fa-align-left"></i> Sinopsis</h3>
                        <p>${manga.synopsis || 'Tidak ada sinopsis tersedia.'}</p>
                    </div>
                    
                    <div class="chapters-section fade-in" style="animation-delay: 0.2s">
                        <h3><i class="fas fa-list"></i> Daftar Chapter (${manga.chapters ? manga.chapters.length : 0})</h3>
                        <div class="chapters-list">
                            ${chaptersHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners to chapter items
            const chapterItems = detailContentEl.querySelectorAll('.chapter-item[data-slug]');
            chapterItems.forEach(item => {
                item.addEventListener('click', () => {
                    const chapterSlug = item.dataset.slug;
                    showChapter(chapterSlug);
                });
            });
        }
        
        function renderChapterImages(chapterData) {
            chapterImagesEl.innerHTML = '';
            
            if (!chapterData.images || chapterData.images.length === 0) {
                chapterImagesEl.innerHTML = `
                    <div class="text-center fade-in">
                        <p style="color: #aaa; padding: 40px 20px;">
                            <i class="fas fa-image" style="font-size: 2.5rem; margin-bottom: 15px; display: block;"></i>
                            Tidak ada gambar yang tersedia untuk chapter ini.
                        </p>
                `;
                readerProgressText.textContent = 'Tidak ada gambar';
                readingProgressEl.style.width = '100%';
                return;
            }
            
            totalImagesCount = chapterData.images.length;
            loadedImagesCount = 0;
            
            readerProgressText.textContent = `Memuat gambar (0/${totalImagesCount})`;
            initLazyLoading();
            
            // Create image containers dengan data-src untuk lazy loading
            chapterData.images.forEach((imageUrl, index) => {
                const imageNumber = index + 1;
                const container = document.createElement('div');
                container.className = 'chapter-image-container fade-in';
                container.style.animationDelay = `${index * 0.05}s`;
                
                container.innerHTML = `
                    <img 
                        data-src="${imageUrl}" 
                        alt="Page ${imageNumber}" 
                        class="chapter-image"
                    >
                    <div class="image-number">${imageNumber}/${totalImagesCount}</div>
                `;
                
                chapterImagesEl.appendChild(container);
                
                // Observasi gambar untuk lazy loading
                const img = container.querySelector('img');
                imageObserver.observe(img);
            });
            
            // Pre-load 3 gambar pertama untuk UX yang lebih baik
            const firstImages = chapterImagesEl.querySelectorAll('img');
            for (let i = 0; i < Math.min(3, firstImages.length); i++) {
                loadImage(firstImages[i]);
            }
        }
        
        // ========== NAVIGATION FUNCTIONS ==========
        
        function updateChapterNavigation(chapterData) {
            const hasPrevChapter = chapterData.previous_chapter_slug && chapterData.previous_chapter_slug !== '';
            const hasNextChapter = chapterData.next_chapter_slug && chapterData.next_chapter_slug !== '';
            
            prevChapterBtn.disabled = !hasPrevChapter;
            prevChapterBtnBottom.disabled = !hasPrevChapter;
            nextChapterBtn.disabled = !hasNextChapter;
            nextChapterBtnBottom.disabled = !hasNextChapter;
        }
        
        function showChapter(chapterSlug) {
            showReaderView();
            fetchChapterImages(chapterSlug);
        }
        
        function goToNextChapter() {
            if (currentChapterData && currentChapterData.next_chapter_slug) {
                showChapter(currentChapterData.next_chapter_slug);
            }
        }
        
        function goToPrevChapter() {
            if (currentChapterData && currentChapterData.previous_chapter_slug) {
                showChapter(currentChapterData.previous_chapter_slug);
            }
        }
        
        function showMangaDetail(slug) {
            currentMangaSlug = slug;
            showDetailView();
            fetchMangaDetail(slug);
        }
        
        function updatePagination(meta) {
            if (!meta) {
                hideElement(paginationEl);
                return;
            }
            
            currentPage = meta.page || 1;
            currentPageEl.textContent = currentPage;
            
            prevBtn.disabled = !meta.prev_page;
            nextBtn.disabled = !meta.next_page;
            
            showElement(paginationEl);
        }
        
        // ========== EVENT LISTENERS ==========
        
        // Navigation
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                fetchManga(currentPage - 1);
            }
        });
        
        nextBtn.addEventListener('click', () => {
            fetchManga(currentPage + 1);
        });
        
        retryBtn.addEventListener('click', () => {
            fetchManga(currentPage);
        });
        
        detailRetryBtn.addEventListener('click', () => {
            if (currentMangaSlug) {
                fetchMangaDetail(currentMangaSlug);
            }
        });
        
        readerRetryBtn.addEventListener('click', () => {
            if (currentChapterSlug) {
                fetchChapterImages(currentChapterSlug);
            }
        });
        
        backBtn.addEventListener('click', () => {
            showListView();
        });
        
        readerBackBtn.addEventListener('click', () => {
            showDetailView();
        });
        
        logoBtn.addEventListener('click', () => {
            showListView();
        });
        
        // Chapter navigation
        prevChapterBtn.addEventListener('click', goToPrevChapter);
        nextChapterBtn.addEventListener('click', goToNextChapter);
        prevChapterBtnBottom.addEventListener('click', goToPrevChapter);
        nextChapterBtnBottom.addEventListener('click', goToNextChapter);
        
        // Browser history
        window.addEventListener('popstate', () => {
            const hash = window.location.hash;
            
            if (!hash) {
                showListView();
            } else if (hash.startsWith('#manga-')) {
                const slug = hash.replace('#manga-', '');
                currentMangaSlug = slug;
                showDetailView();
                fetchMangaDetail(slug);
            } else if (hash.startsWith('#chapter-')) {
                const slug = hash.replace('#chapter-', '');
                currentChapterSlug = slug;
                showReaderView();
                fetchChapterImages(slug);
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (currentView === 'reader') {
                if (e.key === 'ArrowLeft' && !prevChapterBtn.disabled) {
                    goToPrevChapter();
                } else if (e.key === 'ArrowRight' && !nextChapterBtn.disabled) {
                    goToNextChapter();
                } else if (e.key === 'Escape') {
                    showDetailView();
                }
            }
        });
        
        // Swipe gestures
        let touchStartX = 0;
        
        document.addEventListener('touchstart', (e) => {
            if (currentView === 'reader') {
                touchStartX = e.changedTouches[0].screenX;
            }
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            if (currentView === 'reader') {
                const touchEndX = e.changedTouches[0].screenX;
                const diff = touchStartX - touchEndX;
                const swipeThreshold = 50;
                
                if (diff > swipeThreshold && !nextChapterBtn.disabled) {
                    goToNextChapter();
                } else if (diff < -swipeThreshold && !prevChapterBtn.disabled) {
                    goToPrevChapter();
                }
            }
        }, { passive: true });
        
        // ========== INITIALIZE ==========
        
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            
            if (hash.startsWith('#chapter-')) {
                const slug = hash.replace('#chapter-', '');
                currentChapterSlug = slug;
                showReaderView();
                fetchChapterImages(slug);
            } else if (hash.startsWith('#manga-')) {
                const slug = hash.replace('#manga-', '');
                currentMangaSlug = slug;
                showDetailView();
                fetchMangaDetail(slug);
            } else {
                fetchManga();
            }
        });
    </script>
</body>
</html>
